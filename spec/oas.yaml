openapi: 3.0.0
info:
  title: Microservice API
  version: unknown
  description: This is an OAS description of this Microservice REST API
servers:
  - url: /
components:
  securitySchemes:
    gatewayAuth:
      type: apiKey
      in: header
      name: x-gateway-authenticated
      description: Header de autenticación inyectado por el API Gateway. Debe ser 'true'
    userId:
      type: apiKey
      in: header
      name: x-user-id
      description: ID del usuario autenticado, inyectado por el API Gateway
    userRoles:
      type: apiKey
      in: header
      name: x-roles
      description: Roles del usuario separados por comas, inyectado por el API Gateway
  schemas:
    Beat:
      type: object
      required:
        - title
        - genre
        - bpm
        - duration
        - audio
      properties:
        _id:
          type: string
          description: ID único del beat
        title:
          type: string
          maxLength: 100
          description: Título del beat
        createdBy:
          type: object
          description: Información del usuario creador
          properties:
            userId:
              type: string
              description: ID del usuario
            username:
              type: string
              description: Nombre de usuario
            roles:
              type: array
              items:
                type: string
              description: Roles del usuario
        genre:
          type: string
          enum:
            - Hip Hop
            - Trap
            - R&B
            - Pop
            - Rock
            - Electronic
            - Jazz
            - Reggaeton
            - Other
          description: Género musical
        bpm:
          type: number
          minimum: 60
          maximum: 200
          description: Beats por minuto
        duration:
          type: number
          minimum: 10
          description: Duración en segundos
        tags:
          type: array
          items:
            type: string
          description: Etiquetas del beat
        audio:
          type: object
          properties:
            s3Key:
              type: string
              description: Clave S3 del archivo de audio
            s3CoverKey:
              type: string
              description: Clave S3 de la portada (opcional)
            url:
              type: string
              description: URL pública del archivo de audio (virtual property)
            filename:
              type: string
              description: Nombre del archivo
            size:
              type: number
              description: Tamaño del archivo en bytes
            format:
              type: string
              enum:
                - mp3
                - wav
                - flac
                - aac
        pricing:
          type: object
          properties:
            isFree:
              type: boolean
            price:
              type: number
        stats:
          type: object
          properties:
            plays:
              type: number
            downloads:
              type: number
        updatedAt:
          type: string
          format: date-time
    BeatInput:
      type: object
      required:
        - title
        - genre

        - audio
      properties:
        title:
          type: string
          maxLength: 100
          example: Summer Vibes
        genre:
          type: string
          enum:
            - Hip Hop
            - Trap
            - R&B
            - Pop
            - Rock
            - Electronic
            - Jazz
            - Reggaeton
            - Other
          example: Hip Hop
        bpm:
          type: number
          minimum: 60
          maximum: 200
          example: 120
        duration:
          type: number
          minimum: 10
          example: 180
        tags:
          type: array
          items:
            type: string
          example:
            - chill
            - summer
            - trap
        description:
          type: string
          maxLength: 500
          example: A chill summer beat perfect for relaxing
        audio:
          type: object
          required:
            - s3Key
            - filename
            - size
            - format
          properties:
            s3Key:
              type: string
              description: S3 key obtenido del endpoint /upload-url
              example: beats/user123/1732819200000-summer-vibes.mp3
            s3CoverKey:
              type: string
              description: S3 key opcional para la imagen de portada
              example: beats/covers/user123/1732819200000-cover.jpg
            filename:
              type: string
              example: summer-vibes.mp3
            size:
              type: number
              example: 5242880
            format:
              type: string
              enum:
                - mp3
                - wav
                - flac
                - aac
              example: mp3
        pricing:
          type: object
          properties:
            isFree:
              type: boolean
              default: true
            price:
              type: number
              minimum: 0
              example: 0
        isPublic:
          type: boolean
          default: true
          description: Si el beat es público o privado
paths:
  /api/v1/about:
    get:
      tags:
        - Documentation
      summary: Retrieve the entire README file as HTML.
      description: Reads the entire README file and returns its content as HTML.
      responses:
        '200':
          description: Successfully retrieved the README file content as HTML.
          content:
            text/html:
              schema:
                type: string
                description: The HTML content of the README file.
        '500':
          description: Error reading the README file.
          content:
            text/plain:
              schema:
                type: string
                description: Error message when the file cannot be read.
                example: 'Error reading the file: [error details]'
  /api/v1/version:
    get:
      tags:
        - Documentation
      summary: Retrieve the API version from the .version file.
      description: >-
        Reads the .version file and returns its content as part of a JSON
        message.
      responses:
        '200':
          description: Successfully retrieved the API version.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    description: The current API version.
                    example: v1.0.0
        '500':
          description: Error reading the .version file.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    description: Error message summary.
                    example: There was an error retrieving API version
                  error:
                    type: string
                    description: Detailed error message.
                    example: 'ENOENT: no such file or directory, open ''.version'''
  /api/v1/changelog:
    get:
      tags:
        - Documentation
      summary: Retrieve the API changelog.
      description: >
        Reads the `CHANGELOG.md` file, parses its content, and returns it as
        HTML. Supports filtering by specific versions, multiple versions, or a
        version range.
      parameters:
        - in: query
          name: versions
          schema:
            type: string
          description: >
            Comma-separated list of release versions to retrieve (e.g.
            `v2.1.4,v2.1.2`).
        - in: query
          name: from
          schema:
            type: string
          description: >
            Starting release version for the changelog range (inclusive, e.g.
            `v2.1.2`).
        - in: query
          name: to
          schema:
            type: string
          description: >
            Ending release version for the changelog range (inclusive, e.g.
            `v2.1.4`).
      responses:
        '200':
          description: Successfully retrieved the changelog.
          content:
            text/html:
              schema:
                type: string
                description: The HTML representation of the changelog or filtered releases.
        '500':
          description: Error reading the CHANGELOG.md file.
          content:
            text/plain:
              schema:
                type: string
                description: Error message when the changelog cannot be read.
                example: >-
                  There was an error retrieving API release notes: ENOENT: no
                  such file or directory, open 'CHANGELOG.md'
  /api/v1/beats/upload-url:
    post:
      tags:
        - Beats
      summary: Generate presigned URL for audio upload
      description: >
        Generates a presigned URL for direct upload of audio files to S3.

        The URL is valid for 60 seconds. After uploading to S3, use the returned
        s3Key

        to create the beat via POST /api/v1/beats. Requiere autenticación.
      security:
        - gatewayAuth: []
          userId: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - extension
                - mimetype
              properties:
                extension:
                  type: string
                  enum:
                    - mp3
                    - wav
                    - flac
                    - aac
                  example: mp3
                  description: File extension without the dot
                mimetype:
                  type: string
                  example: audio/mpeg
                  description: MIME type of the audio file
                size:
                  type: number
                  example: 5242880
                  description: File size in bytes (max 50MB)
      responses:
        '200':
          description: Presigned URL generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Upload URL generated successfully
                  data:
                    type: object
                    properties:
                      uploadUrl:
                        type: string
                        example: >-
                          https://social-beats-storage.s3.eu-north-1.amazonaws.com/users/anonymous/abc-123.mp3?X-Amz-...
                        description: Presigned URL for PUT request to S3
                      s3Key:
                        type: string
                        example: users/anonymous/abc-123.mp3
                        description: S3 key to use when creating the beat
                      expiresIn:
                        type: number
                        example: 60
                        description: URL expiration time in seconds
        '400':
          description: Invalid request (missing fields, invalid file type, size exceeded)
        '500':
          description: Server error generating presigned URL
  /api/v1/beats:
    post:
      tags:
        - Beats
      summary: Crear un nuevo beat
      description: >-
        Crea un nuevo beat en la plataforma. Requiere autenticación a través del
        API Gateway.
      security:
        - gatewayAuth: []
          userId: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BeatInput'
      responses:
        '201':
          description: Beat creado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Beat created successfully
                  data:
                    $ref: '#/components/schemas/Beat'
        '400':
          description: Error de validación
        '500':
          description: Error interno del servidor
    get:
      tags:
        - Beats
      summary: Obtener todos los beats
      description: Obtiene una lista paginada de beats con filtros opcionales
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            default: 1
          description: Número de página
        - in: query
          name: limit
          schema:
            type: integer
            default: 10
            maximum: 50
          description: Cantidad de elementos por página
        - in: query
          name: genre
          schema:
            type: string
          description: Filtrar por género
        - in: query
          name: artist
          schema:
            type: string
          description: Filtrar por artista
        - in: query
          name: minBpm
          schema:
            type: integer
          description: BPM mínimo
        - in: query
          name: maxBpm
          schema:
            type: integer
          description: BPM máximo
        - in: query
          name: tags
          schema:
            type: string
          description: Filtrar por tags (separados por coma)
        - in: query
          name: isFree
          schema:
            type: boolean
          description: Filtrar beats gratuitos/pagos
        - in: query
          name: sortBy
          schema:
            type: string
            default: createdAt
          description: Campo para ordenar
        - in: query
          name: sortOrder
          schema:
            type: string
            enum:
              - asc
              - desc
            default: desc
          description: Orden de clasificación
      responses:
        '200':
          description: Lista de beats obtenida exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Beats retrieved successfully
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Beat'
                  pagination:
                    type: object
                    properties:
                      currentPage:
                        type: integer
                      totalPages:
                        type: integer
                      totalBeats:
                        type: integer
                      hasNext:
                        type: boolean
                      hasPrev:
                        type: boolean
  /api/v1/beats/search:
    get:
      tags:
        - Beats
      summary: Buscar beats
      description: Busca beats por título, artista, tags o descripción
      parameters:
        - in: query
          name: q
          required: true
          schema:
            type: string
            minLength: 2
          description: Término de búsqueda
        - in: query
          name: page
          schema:
            type: integer
            default: 1
          description: Número de página
        - in: query
          name: limit
          schema:
            type: integer
            default: 10
            maximum: 50
          description: Cantidad de resultados por página
      responses:
        '200':
          description: Búsqueda realizada exitosamente
        '400':
          description: Término de búsqueda inválido
  /api/v1/beats/my-beats:
    get:
      tags:
        - Beats
      summary: Obtener mis beats
      description: >-
        Obtiene todos los beats del usuario autenticado (incluye beats
        privados). Requiere autenticación a través del API Gateway.
      security:
        - gatewayAuth: []
          userId: []
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            default: 1
          description: Número de página
        - in: query
          name: limit
          schema:
            type: integer
            default: 10
            maximum: 50
          description: Cantidad de elementos por página
        - in: query
          name: includePrivate
          schema:
            type: boolean
            default: true
          description: Incluir beats privados en los resultados
        - in: query
          name: genre
          schema:
            type: string
          description: Filtrar por género
        - in: query
          name: minBpm
          schema:
            type: integer
          description: BPM mínimo
        - in: query
          name: maxBpm
          schema:
            type: integer
          description: BPM máximo
        - in: query
          name: tags
          schema:
            type: string
          description: Filtrar por tags (separados por coma)
        - in: query
          name: isFree
          schema:
            type: boolean
          description: Filtrar beats gratuitos/pagos
        - in: query
          name: sortBy
          schema:
            type: string
            default: createdAt
          description: Campo para ordenar
        - in: query
          name: sortOrder
          schema:
            type: string
            enum:
              - asc
              - desc
            default: desc
          description: Orden de clasificación
      responses:
        '200':
          description: Beats del usuario obtenidos exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: User beats retrieved successfully
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Beat'
                  pagination:
                    type: object
                    properties:
                      currentPage:
                        type: integer
                      totalPages:
                        type: integer
                      totalBeats:
                        type: integer
                      hasNext:
                        type: boolean
                      hasPrev:
                        type: boolean
                  userId:
                    type: string
                    description: ID del usuario propietario de los beats
        '401':
          description: No autenticado - falta header de autenticación del gateway
        '500':
          description: Error interno del servidor
  /api/v1/beats/stats:
    get:
      tags:
        - Beats
      summary: Obtener estadísticas
      description: Obtiene estadísticas generales de los beats
      responses:
        '200':
          description: Estadísticas obtenidas exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      general:
                        type: object
                        properties:
                          totalBeats:
                            type: number
                          totalPlays:
                            type: number
                          totalDownloads:
                            type: number
                          avgDuration:
                            type: number
                      genres:
                        type: array
                        items:
                          type: object
                          properties:
                            _id:
                              type: string
                            count:
                              type: number
  /api/v1/beats/{id}/audio:
    get:
      tags:
        - Beats
      summary: Stream audio
      description: Redirects to a presigned S3 URL for audio playback
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Beat ID
      responses:
        '302':
          description: Redirect to S3
        '404':
          description: Beat not found
  /api/v1/beats/{id}:
    get:
      tags:
        - Beats
      summary: Obtener un beat por ID
      description: >-
        Obtiene los detalles de un beat específico. Si el beat es privado,
        requiere autenticación y ser el propietario.
      security:
        - gatewayAuth: []
          userId: []
        - {}
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: ID del beat
      responses:
        '200':
          description: Beat obtenido exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Beat retrieved successfully
                  data:
                    $ref: '#/components/schemas/Beat'
        '400':
          description: ID de beat inválido
        '404':
          description: Beat no encontrado
    put:
      tags:
        - Beats
      summary: Actualizar un beat
      description: >-
        Actualiza los datos de un beat existente. Requiere ser el propietario
        del beat o administrador.
      security:
        - gatewayAuth: []
          userId: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: ID del beat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BeatInput'
      responses:
        '200':
          description: Beat actualizado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Beat updated successfully
                  data:
                    $ref: '#/components/schemas/Beat'
        '400':
          description: Error de validación
        '404':
          description: Beat no encontrado
    delete:
      tags:
        - Beats
      summary: Eliminar un beat
      description: >-
        Elimina un beat permanentemente de la base de datos. Requiere ser el
        propietario del beat o administrador.
      security:
        - gatewayAuth: []
          userId: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: ID del beat
      responses:
        '200':
          description: Beat eliminado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Beat deleted successfully
        '400':
          description: ID de beat inválido
        '404':
          description: Beat no encontrado
  /api/v1/beats/{id}/play:
    post:
      tags:
        - Beats
      summary: Reproducir beat
      description: >-
        Incrementa el contador de reproducciones del beat. Requiere
        autenticación. Si el beat es privado, solo el propietario puede
        reproducirlo.
      security:
        - gatewayAuth: []
          userId: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: ID del beat
      responses:
        '200':
          description: Contador de reproducciones actualizado
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Play count updated
                  data:
                    type: object
                    properties:
                      beatId:
                        type: string
                      plays:
                        type: number
        '401':
          description: No autenticado
        '403':
          description: Sin permisos para reproducir este beat privado
        '404':
          description: Beat no encontrado
  /api/v1/health:
    get:
      tags:
        - Health
      summary: Health check endpoint
      description: Returns basic information to verify that the API is running properly.
      responses:
        '200':
          description: API is healthy and responding.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  message:
                    type: string
                    example: Health check successful
                  version:
                    type: string
                    example: 1.0.0
                  uptime:
                    type: number
                    example: 123.45
                  timestamp:
                    type: string
                    format: date-time
                    example: '2025-11-08T13:41:47.074Z'
                  environment:
                    type: string
                    example: development
                  db:
                    type: string
                    example: connected
tags: []
